<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fragmento 4 - Sincronia</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            width: 100%; height: 100%; font-family: 'Space Mono', monospace;
            background: #050505; color: #00ff41; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #status-bar {
            position: absolute; top: 20px; width: 100%; text-align: center;
            letter-spacing: 2px; font-size: 0.7rem; opacity: 0.6;
        }

        #game { display: none; flex-direction: column; align-items: center; gap: 30px; z-index: 10; width: 90%; }

        .progress-info { text-align: center; margin-bottom: 10px; }
        .level-text { font-size: 1.2rem; color: #fff; text-shadow: 0 0 10px #00ff41; }

        /* Grade de Símbolos */
        .symbols { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        
        .symbol {
            width: 85px; height: 85px; border: 2px solid #00ff41; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; transition: all 0.2s; background: rgba(0, 255, 65, 0.05);
            user-select: none;
        }

        /* Efeito de flash (diminui nos níveis finais) */
        .symbol.flash { background: #00ff41; color: #000; box-shadow: 0 0 30px #00ff41; border-color: #fff; }

        /* TELA FINAL */
        #final { display: none; flex-direction: column; align-items: center; text-align: center; gap: 20px; animation: fadeIn 2s; }
        .digit { font-size: 7rem; font-weight: bold; color: #fff; text-shadow: 0 0 25px #00ff41; }
        
        button {
            padding: 15px 40px; background: transparent; border: 1px solid #00ff41;
            color: #00ff41; font-family: 'Space Mono'; cursor: pointer; text-transform: uppercase;
            border-radius: 5px;
        }
        button:active { background: #00ff41; color: #000; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body>

    <div id="status-bar">FRAGMENTO_MEMORIA_M4: <span id="sync-status">ESTÁVEL</span></div>

    <div id="game">
        <div class="progress-info">
            <div class="level-text">ESTÁGIO <span id="level-num">1</span>/5</div>
            <p style="font-size: 0.8rem; margin-top: 5px;">Memorize a sequência...</p>
        </div>
        
        <div class="symbols">
            <div class="symbol" data-id="0" data-freq="261">Δ</div>
            <div class="symbol" data-id="1" data-freq="329">Ω</div>
            <div class="symbol" data-id="2" data-freq="392">Σ</div>
            <div class="symbol" data-id="3" data-freq="523">Φ</div>
        </div>
    </div>

    <div id="final">
        <p style="letter-spacing: 2px;">SINCRONIA COMPLETA</p>
        <div class="digit">3</div>
        <p style="font-size: 0.8rem; margin-bottom: 20px;">O segundo dígito foi recuperado.</p>
        <button onclick="window.location.href='index.html'">Finalizar Protocolo</button>
    </div>

    <script>
        let sequence = [];
        let userInput = [];
        let currentLevel = 1;
        const maxLevel = 5;

        // Gerador de Áudio (Notas musicais limpas)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(freq) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        const gameDiv = document.getElementById('game');
        const levelSpan = document.getElementById('level-num');
        const syncStatus = document.getElementById('sync-status');

        // Início automático após breve delay
        setTimeout(() => {
            gameDiv.style.display = 'flex';
            startLevel();
        }, 2000);

        function startLevel() {
            userInput = [];
            levelSpan.innerText = currentLevel;
            
            // Dificuldade crescente: Nível 1 (3 notas) -> Nível 5 (7 notas)
            const length = currentLevel + 2;
            sequence = Array.from({length: length}, () => Math.floor(Math.random() * 4));
            
            if(currentLevel >= 4) syncStatus.innerText = "INSTÁVEL - FOCO NO SOM";
            
            setTimeout(playSequence, 1000);
        }

        async function playSequence() {
            gameDiv.style.pointerEvents = 'none';
            for (let id of sequence) {
                await new Promise(r => setTimeout(r, 600));
                const el = document.querySelector(`[data-id="${id}"]`);
                
                playNote(el.dataset.freq);
                
                // No nível 4 e 5, o brilho visual some! Ela terá que usar o ouvido.
                if (currentLevel < 4) {
                    el.classList.add('flash');
                    setTimeout(() => el.classList.remove('flash'), 400);
                } else {
                    el.style.borderColor = "#fff";
                    setTimeout(() => el.style.borderColor = "#00ff41", 400);
                }
            }
            gameDiv.style.pointerEvents = 'all';
        }

        document.querySelectorAll('.symbol').forEach(btn => {
            btn.addEventListener('click', () => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                
                const id = Number(btn.dataset.id);
                playNote(btn.dataset.freq);
                btn.classList.add('flash');
                setTimeout(() => btn.classList.remove('flash'), 250);
                
                handleInput(id);
            });
        });

        function handleInput(id) {
            if (id === sequence[userInput.length]) {
                userInput.push(id);
                if (userInput.length === sequence.length) {
                    if (currentLevel === maxLevel) win();
                    else { currentLevel++; setTimeout(startLevel, 1000); }
                }
            } else {
                // Errou? Volta pro nível 1 para dar aquele "desespero" engraçado
                gameDiv.classList.add('shake');
                syncStatus.innerText = "ERRO DE SINCRONIA - REINICIANDO";
                setTimeout(() => {
                    gameDiv.classList.remove('shake');
                    currentLevel = 1;
                    startLevel();
                }, 600);
            }
        }

        function win() {
            gameDiv.style.display = 'none';
            const final = document.getElementById('final');
            final.style.display = 'flex';
            localStorage.setItem('enigma4_concluido', 'true');
        }
    </script>
</body>
</html>
